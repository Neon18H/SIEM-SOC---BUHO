{% extends 'base.html' %}
{% load static %}

{% block breadcrumbs %}<span class="text-secondary">SOC / Dashboard</span>{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">

<div class="dashboard-shell mt-3">
  <div class="row g-3">
    <div class="col-lg-3 col-md-6">
      <article class="card kpi-card border-0 shadow-sm metric-events">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <span class="kpi-title">Eventos 24h</span>
            <i class="bi bi-activity"></i>
          </div>
          <h2 class="kpi-value">{{ kpis.total_events }}</h2>
          <p class="kpi-subtext mb-0">Actividad monitoreada</p>
          <span class="trend trend-{{ trends.total_events }}">
            {% if trends.total_events == 'up' %}↑ Incremento{% elif trends.total_events == 'down' %}↓ Descenso{% else %}→ Estable{% endif %}
          </span>
        </div>
      </article>
    </div>

    <div class="col-lg-3 col-md-6">
      <article class="card kpi-card border-0 shadow-sm metric-critical">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <span class="kpi-title">Alertas críticas</span>
            <i class="bi bi-exclamation-triangle"></i>
          </div>
          <h2 class="kpi-value">{{ kpis.critical_alerts }}</h2>
          <p class="kpi-subtext mb-0">Severidad Critical</p>
          <span class="trend trend-{{ trends.critical_alerts }}">
            {% if trends.critical_alerts == 'up' %}↑ Incremento{% elif trends.critical_alerts == 'down' %}↓ Descenso{% else %}→ Estable{% endif %}
          </span>
        </div>
      </article>
    </div>

    <div class="col-lg-3 col-md-6">
      <article class="card kpi-card border-0 shadow-sm metric-auth-fail">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <span class="kpi-title">Auth failures</span>
            <i class="bi bi-shield-x"></i>
          </div>
          <h2 class="kpi-value">{{ kpis.auth_failures }}</h2>
          <p class="kpi-subtext mb-0">Intentos fallidos</p>
          <span class="trend trend-{{ trends.auth_failures }}">
            {% if trends.auth_failures == 'up' %}↑ Incremento{% elif trends.auth_failures == 'down' %}↓ Descenso{% else %}→ Estable{% endif %}
          </span>
        </div>
      </article>
    </div>

    <div class="col-lg-3 col-md-6">
      <article class="card kpi-card border-0 shadow-sm metric-auth-success">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <span class="kpi-title">Auth success</span>
            <i class="bi bi-shield-check"></i>
          </div>
          <h2 class="kpi-value">{{ kpis.auth_success }}</h2>
          <p class="kpi-subtext mb-0">Autenticaciones correctas · {{ kpis.agents_online }} agentes online</p>
          <span class="trend trend-{{ trends.auth_success }}">
            {% if trends.auth_success == 'up' %}↑ Incremento{% elif trends.auth_success == 'down' %}↓ Descenso{% else %}→ Estable{% endif %}
          </span>
        </div>
      </article>
    </div>
  </div>

  <div class="row g-3 mt-1">
    <div class="col-lg-8">
      <section class="card border-0 shadow-sm panel-card h-100">
        <div class="card-header border-0 bg-transparent d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Eventos por severidad (últimas 24h)</h5>
          <span class="badge text-bg-secondary">Tiempo real</span>
        </div>
        <div class="card-body"><canvas id="eventsSeverityChart"></canvas></div>
      </section>
    </div>
    <div class="col-lg-4">
      <section class="card border-0 shadow-sm panel-card h-100">
        <div class="card-header border-0 bg-transparent"><h5 class="mb-0">Distribución MITRE ATT&CK</h5></div>
        <div class="card-body"><canvas id="mitreChart"></canvas></div>
      </section>
    </div>
  </div>

  <div class="row g-3 mt-1">
    <div class="col-lg-4">
      <section class="card border-0 shadow-sm panel-card h-100">
        <div class="card-header border-0 bg-transparent"><h5 class="mb-0">Distribución de sistemas operativos</h5></div>
        <div class="card-body"><canvas id="osChart"></canvas></div>
      </section>
    </div>
    <div class="col-lg-8">
      <section class="card border-0 shadow-sm panel-card h-100">
        <div class="card-header border-0 bg-transparent"><h5 class="mb-0">Top 5 agentes por eventos</h5></div>
        <div class="card-body"><canvas id="agentsChart"></canvas></div>
      </section>
    </div>
  </div>

  <div class="row g-3 mt-1">
    <div class="col-12">
      <section class="card border-0 shadow-sm panel-card">
        <div class="card-header border-0 bg-transparent"><h5 class="mb-0">Alertas recientes</h5></div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-dark table-hover align-middle mb-0">
              <thead>
                <tr>
                  <th>Hora</th>
                  <th>Título</th>
                  <th>Severidad</th>
                  <th>Estado</th>
                  <th>Asignado</th>
                </tr>
              </thead>
              <tbody>
                {% for alert in recent_alerts %}
                <tr>
                  <td>{{ alert.created_at|date:'Y-m-d H:i' }}</td>
                  <td>{{ alert.title|truncatechars:90 }}</td>
                  <td><span class="severity-badge severity-{{ alert.severity|lower }}">{{ alert.severity }}</span></td>
                  <td><span class="badge rounded-pill text-bg-secondary">{{ alert.get_status_display }}</span></td>
                  <td>{{ alert.assignee.username|default:'Sin asignar' }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="5" class="text-center py-4 text-secondary">No hay alertas recientes.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </div>
</div>

{{ time_series_data|json_script:"time-series-data" }}
{{ mitre_distribution|json_script:"mitre-distribution" }}
{{ os_distribution|json_script:"os-distribution" }}
{{ top_agents|json_script:"top-agents" }}
<script src="{% static 'js/dashboard.js' %}"></script>
{% endblock %}
